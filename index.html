<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- ✅ SEO & Social Share -->
  <meta property="og:image" content="assets/icon-512.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yuda2525.github.io/YOUR-PWA-FOLDER/">

  <!-- ✅ Favicon & Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <link rel="icon" sizes="512x512" href="assets/icon-512.png">

  <!-- ✅ PWA Essentials -->
  <meta name="theme-color" content="#00ffe4" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="stylesheet" href="style.css">
     <meta name="color-scheme" content="dark light">    
    <title>Hybrid MP3/MP4 Player</title>
<link rel="apple-touch-startup-image" href="assets/splash-screen.png">        
  <meta name="apple-mobile-web-app-title" content="MediaPlayer" />

<!-- Android Theme -->            
<meta name="mobile-web-app-capable" content="yes" />          
  <style>
  	    * {  
      margin: 0;  
      padding: 0;  
      box-sizing: border-box;  
    }  

  video, canvas, img {
    filter: brightness(95%);
  }
    
:root {
  --color-primary: rgba(0, 255, 238, 0.08);       /* soft glass base */
  --color-accent: #ff4de8;
  --color-background: linear-gradient(120deg, #0e0e0e, #1a1a1a);
  --shadow-depth: 0 10px 32px rgba(0, 255, 255, 0.15);
  --glow-effect: 0 0 12px rgba(0, 255, 238, 0.6);

  --glass-blur: blur(18px);
  --border-glass: rgba(255, 255, 255, 0.1);
  --color-glow: rgba(0, 255, 238, 0.25);
}

body {
  background-image: var(--color-background), url('assets/bg.jpg');
  background-size: cover, cover;
  background-position: center, center;
  background-repeat: no-repeat, no-repeat;
  background-attachment: fixed, fixed;
  color: white;
  font-family: 'Poppins', sans-serif;
  filter: contrast(105%) saturate(115%) brightness(1.03);
  margin: 0;
  padding: 0;
}

/* Retina Glass Card */
.glass-retina {
  background: var(--color-primary);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--border-glass);
  border-radius: 20px;
  box-shadow:
    inset 0 0 0.5px rgba(255, 255, 255, 0.1),
    0 4px 16px var(--color-glow),
    0 8px 24px rgba(0, 0, 0, 0.2);
  padding: 24px;
  transition: all 0.4s ease;
}

/* Hover effect (optional) */
.glass-retina:hover {
  transform: scale(1.02);
  box-shadow:
    inset 0 0 1px rgba(255, 255, 255, 0.15),
    0 6px 28px rgba(0, 255, 238, 0.35),
    0 12px 36px rgba(0, 0, 0, 0.3);
}

/* 3D Card Base */
.card-3d {
  box-shadow: var(--shadow-depth);
  transform: perspective(900px) rotateX(2deg);
  backdrop-filter: blur(12px) brightness(1.08);
  border-radius: 16px;
  padding: 20px;
  transition: all 0.4s ease;
}

  .visual-mode-all {
    filter:
      hue-rotate(5deg)
      saturate(1.6)
      contrast(1.2)
      brightness(1.1)
      contrast(1.1)
      brightness(0.95)
      saturate(1.2)
      brightness(1.3)
      contrast(1.25)
      saturate(1.4);
    transform: perspective(1000px) rotateX(2deg);
    border-radius: 12px;
    transition: all 0.5s ease;
  }
  
  @supports (backdrop-filter: blur(10px)) {
  .glass {
    backdrop-filter: blur(10px);
  }
}
  
  .glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  box-shadow: 0 0 30px rgba(0, 200, 255, 0.3);
  border-radius: 15px;
}
  
  .dynamic-light {
  background: radial-gradient(circle at var(--x) var(--y), rgba(255,255,255,0.1), transparent 80%);
}

    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    video, audio {
      width: 100%;
      max-width: 500px;
      margin: 1rem 0;
      background: #000;
    }
    
    .controls {
      margin-top: 1rem;
    }
    select, input {
      font-size: 1rem;
      padding: 0.4rem;
      margin: 0.2rem;
    }
    
      
    .eq-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      width: 92vw;
      max-width: 360px;
    }

    .eq-container {
      display: flex;
      gap: 6px; 
    }

    .eq-sliders {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      width: 28px;
      position: relative;
    }

    .slider-wrapper {
      position: relative;
      height: 140px;
      width: 20px;
      background: none;
    }

    .slider-wrapper::before {
      content: '';
      position: absolute;
      top: 8px;
      bottom: 8px;
      left: 50%;
      width: 2px;
      background: linear-gradient(to bottom, #666, #aaa, #666);
      transform: translateX(-50%);
    }

    .slider-lines {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .slider-lines span {
      height: 1px;
      background: #444;
      opacity: 0.6;
    }

    .slider {
      position: absolute;
      width: 140px;
      height: 20px;
      transform: rotate(270deg);
      top: 50%;
      left: 50%;
      translate: -50% -50%;
      background: transparent;
      appearance: none;
      z-index: 2;
    }

    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 10px;
      height: 10px;
      background: #ccc;
      border: 1px solid #777;
      box-shadow: 0 1px 2px #000a;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 10px;
      height: 10px;
      background: #ccc;
      border: 1px solid #777;
      box-shadow: 0 1px 2px #000a;
      cursor: pointer;
    }

    .freq-label {
      margin-top: 5px;
      font-size: 6px;
      color:  #ffffff;  
       text-align: center;
    }
    
    .hidden {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#realisticPlayer {
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  filter: brightness(1.1) contrast(1.25) saturate(1.15)
          drop-shadow(0 0 30px rgba(0,255,255,0.1))
          drop-shadow(0 0 40px rgba(255,255,255,0.05))
          blur(0.3px);
  transition: all 1s ease-in-out;
  background: radial-gradient(circle at center, #111 10%, #000 100%);
}


  #toggleUIPanel {  
    position: fixed;  
    top: 15px;  
    right: 15px;  
    z-index: 1000;  
    padding: 8px 14px;  
    font-size: 16px;  
    background: rgba(0, 0, 0, 0.6);  
    color: #fff;  
    border: none;  
    border-radius: 8px;  
    cursor: pointer;  
  }  
  
  .controls-wrapper {  
    transition: max-height 0.5s ease, opacity 0.5s ease;  
    overflow: hidden;  
    background: rgba(255, 255, 255, 0.08);  
    padding: 10px;  
    border-radius: 10px;  
    max-height: 500px;  
    opacity: 1;  
  }  
  
  .controls-wrapper.hidden {  
    max-height: 0;  
    opacity: 0;  
    padding: 0 10px;  
  }  

  </style>  
<link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
</head>  
<body onclick="enterFullscreenOnce()">
	
	
	  <div class="eq-wrapper">
    <div class="eq-container" id="eqContainer"></div>
  </div>
  <video id="media" controls></video>
  <audio id="audio" controls hidden></audio>


<!-- Tombol toggle -->  
<button id="toggleUIPanel" onclick="toggleUIPreset()"> UI Panel</button>  
<div class="retina-glass">
	<div id="visualMode" class="content-overlay visual-mode-all">
<!-- Panel Preset dan File Picker -->  
<div id="uiControls" class="controls-wrapper">  
  <input type="file" id="fileInput" accept="audio/*,video/*"> 
  <div class="controls">
    <label>Preset:
      <select id="preset">
      <option value="Flat">Flat</option>  
      <option value="Bass Boost">Bass</option>  
      <option value="Treble Boost">Treble</option>  
      <option value="Rock">Rock</option>  
      <option value="Pop">Pop</option>  
      <option value="Jazz">Jazz</option>  
       <option value="Classic">Classic</option>  
      <option value="Dance">Dance</option>  
            <option value="Chill Vibe">Chill Vibe</option>  
                  <option value="Live Acoustic">Live Acoustic</option>  
                       <option value="DangdutRemix">DangdutRemix</option>  
                              <option value="Bright Mix">Bright Mix</option>  
                                    <option value="Ballad Soft">Ballad Soft</option>  
                                          <option value="EDM Festival">EDM Festival</option>  
                                                <option value="R&B">R&B</option>  
                                                      <option value="Orchestra">Orchestra</option>  
                                                            <option value="Reggae Vibe">Reggae Vibe</option>  
                                                                  <option value="Metal Attack">Metal Attack</option>  
                                                                           <option value="Shape">Shape</option>  
                                                                            <option value="Podcast Clarity">Podcast Clarity</option>  
                                                                                  <option value="Surround Deep">Surround Deep</option>  
                                                                                        <option value="Sub Bass Lift">Sub Bass Lift</option>  
      <option value="Vocal Airy Bright">Vocal Airy Bright</option>  
      <option value0="Treble Sparkle">Treble Sparkle</option>  
      <option value="Hi-Fi Wide Range">Hi-Fi Wide</option>  
        <option value="Warm & Wide">Warm & Wide</option>  
        <option value="Clarity Focus">Clarity Focus</option>  
                        <option value="Funky">Funky</option>  
                                       <option value="Scoopy Smile">Scoopy Smile</option>  
                                        <option value="AmbientSpace">AmbientSpace</option>  
                                                <option value="Bassy Theater">Bassy Theater</option>  
                                                        <option value="Bright Vocal">Bright Vocal</option>  
                                                                <option value="StudioPro">StudioPro</option>  
                                                                        <option value="Funky Shape">Funky Shape</option>  
                                                                                <option value="AmbientNature">AmbientNature</option>  
                                                                                        <option value="Clean Dialog">Clean Dialog</option>  
                                                                           <option value="CinematicWide">CinematicWide</option>  
                                                                                     <option value="Gaming FPS Focus">Gaming FPS Focus</option>  
                                                                                         <option value="Vortex Mode">Vortex Mode</option>  
                                                                                                  <option value="Punchy">Punchy</option>  
                                                                                                 <option value="Boom Room">Boom Room</option>  
                                                                                                    <option value="MidCut">MidCut</option>  
                                                                                                         <option value="Hardcore Punch">Hardcore Punch</option>  
                                                                                                               <option value="Movie">Movie</option>  
                                                                                                                          <option value="ClubNight">ClubNight</option>  
                                                                                                                               <option value="Dolby Atmos Style">Dolby Atmos Style</option>  
                                                                                                                       <option value="LoFi Mode">LoFi Mode</option>  
    </select>  
    </label>
  </div>

  <button onclick="openFullscreen()">Fullscreen</button>
  
<body>  
<canvas id="hiddenCanvas" style="display: none;"></canvas>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>

<script>
window.addEventListener("error", e => console.error("❌ Global Error:", e.message));

// ============ 🎧 GLOBAL SETUP ============
const audio = document.getElementById('audioPlayer');

const eqContainer = document.getElementById('eqContainer');

const trackTitle = document.getElementById('trackTitle');
const timerText = document.getElementById('timerText');

const boostLowBtn = document.getElementById("boostLow");
const boostMidBtn = document.getElementById("boostMid");
const boostHighBtn = document.getElementById("boostHigh");
  
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const mediaEl = document.getElementById('media');
    const audioEl = document.getElementById('audio');
    const fileInput = document.getElementById('fileInput');
    const presetSelect = document.getElementById('preset');
    const bass = audioCtx.createBiquadFilter();
    
let bands = [10, 32, 64, 125, 250, 500, 1000, 2000, 4000, 10000, 16000, 20000];
let playlist;
let currentTrack;
let isRepeat = false;

let volInterval;

let stereoPanner = null;
let stereoGain = null;
let crossfeed = null;

let stereoNode;
let stereoInterval = null;
let crossfeedGainNodeL, crossfeedGainNodeR;
let oscillatorTimer;
let crossfeedL, crossfeedR;
let autoPanTimer;
let panTime = 0;

// ===== ✅ STATUS =====

let boosterActive = false;
let stereoActive = false;

let blendRatio = 0.5; // default 50:50
let blendActive = false;

let lastPresetSource = null;
let showFullClock = false;

let eqNodes = []; // ✅ dideklarasi dulu
let lastEQ = null; // atau bisa pakai function seperti: () => eqNodes.at(-1)
let lastActivePreset = null;
let lastManualPreset = "";

let activeBand = null;
let boosterMode = "Off";
let boosterBand = null;
let boosterAmount = 0;
let eqBeforeBooster = []; // 🔄 Backup preset sebelum booster aktif

let lastRootType = null; // "basic" | "advance"
let lastRootPreset = null;

let eqFilters = [];

let clarity, clarityGain;
let loudnessLow, loudnessHigh;
let subwoofer, deEsser, ambient, toneBias;
let biquadFilters = []; 

let enhancer;
let compressor;

let agcLimiter, peakLimiter;
let gainNode;

let allNodes = [];
let isUpdatingSlider = false;

let analyser;
let harmonicEnhancerNodes = [];
let lastAudioNode = null;
let stereoToggleState = true; // atau false (defaultnya aktif)

let softLimiter = null;
let boosterGainNode = null;

let presetFromDynamic = false;
let waveformActive = false;
let loopVisualizer = true;

// Player
let player; // bakal di-assign saat DOM ready
player = document.getElementById("audioPlayer");

let smartLimiter;

let powerAmpNode;
let harmonicAIEngine;

let lowCutFilter, subShelf, subMidCut, subCompressor;

let snareSnap, snareCutMud, depBoost;
let snareBoost;
let snareAttack, snareCrack, snareBody;

let waveHue = 0;  
  
let enhancerNodes = [];  

let pianoEQ, pianoReverb, pianoCompressor;
let bassEQ, midEQ, trebleEQ;

let mixMidCut, mixAir;
let clarityBoost;
let orchestraEQ;

let  lowShelf, trebleNotch, midCut, highShelf;

let myDecodedBuffer;

let sourceNode;

// Debug toggle
const isDev = false;
function log(...args) {
  if (isDev) console.log(...args);
}

// ============ 🎚️ SLIDER UI ============
function createEQSliders() {
  const eqContainer = document.getElementById("eqContainer");
  if (!eqContainer) {
    console.warn("❌ eqContainer tidak ditemukan!");
    return;
  }

  eqContainer.innerHTML = ""; // 🧹 Clear dulu biar nggak dobel

  bands.forEach((freq, i) => {
    const sliderDiv = document.createElement('div');
    sliderDiv.className = 'eq-slider';

    const wrapper = document.createElement('div');
    wrapper.className = 'slider-wrapper';

    const lines = document.createElement('div');
    lines.className = 'slider-lines';
    for (let j = 0; j < 5; j++) lines.appendChild(document.createElement('span'));

    const slider = document.createElement('input');
    slider.type = 'range';
    slider.className = 'slider';
    slider.min = 0;
    slider.max = 100;
    slider.value = 50;

    slider.addEventListener('input', () => {
      if (isUpdatingSlider) return;
      const val = parseInt(slider.value);
      const db = (val - 50) / 5;
      if (eqNodes[i]) eqNodes[i].gain.value = db;
    });

    wrapper.appendChild(lines);
    wrapper.appendChild(slider);

    const label = document.createElement('div');
    label.className = 'freq-label';
    label.innerText = freq >= 1000 ? (freq / 1000) + "kHz" : freq + "Hz";

    sliderDiv.appendChild(wrapper);
    sliderDiv.appendChild(label);
    eqContainer.appendChild(sliderDiv);
  });

  console.log("✅ EQ sliders created");
}

async function injectPowerAmpV2AndConnect(currentNode) {
  await injectPowerAmpV2();
  if (!powerAmpNode) {
    console.warn("❌ powerAmpNode gagal dibuat");
    return currentNode;
  }

  currentNode.connect(powerAmpNode);
  console.log("⚡ PowerAmp connected!");
  return powerAmpNode;
}

// ============ 🎚️INIT ============
async function initAudioContext() {
  if (!audioCtx) {
    console.log("⚙️ Creating AudioContext...");
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);

if (!audioCtx || audioCtx.state !== "running") {
  console.error("❌ AudioContext belum aktif atau belum dibuat.");
} else {
  console.log("✅ AudioContext aktif:", audioCtx.state);
}

if (!sourceNode) {
  console.warn("⚠️ sourceNode belum didefinisikan.");
} else {
  console.log("🎙️ Source node OK:", sourceNode);
}}
}

    // 🎛️ EQ INIT
    const frequencies = [10, 32, 64, 125, 250, 500, 1000, 2000, 4000, 10000, 16000, 20000];
    eqNodes = frequencies.map(freq => {
      const f = audioCtx.createBiquadFilter();
      f.type = "peaking";
      f.frequency.value = freq;
      f.Q.value = 1;
      f.gain.value = 0;
      return f;
    });
    console.log("🎛️ EQ Nodes initialized");
    

function initEQNodes(audioCtx) {
  if (!audioCtx) {
    console.warn("⛔ audioCtx belum diinisialisasi");
    return;
  }

  const eqConfig = {
    bass:   { freq: 100,  gain: 4, type: "lowshelf" },
    kick:   { freq: 60,   gain: 8, type: "lowshelf" },
    snare:  { freq: 1500, gain: 6, type: "peaking" },
    guitar: { freq: 800,  gain: 2, type: "peaking" },
    hihat:  { freq: 8000, gain: 4, type: "highshelf" },
    piano:  { freq: 1200, gain: 3, type: "peaking" }
  };

  for (const [name, { freq, gain, type }] of Object.entries(eqConfig)) {
    const filter = audioCtx.createBiquadFilter();
    filter.type = type;
    filter.frequency.value = freq;
    filter.gain.value = gain;
    filter.Q.value = 1;
    eqNodes[name] = filter;
  }

  console.log("✅ EQ Nodes initialized:", eqNodes);
}

console.log("🎚 Inisialisasi EQ Filters...");


lowCutFilter = audioCtx.createBiquadFilter();
lowCutFilter.type = "highpass";
lowCutFilter.frequency.value = 30;
lowCutFilter.Q.value = 0.7; // Jangan terlalu sempit

subShelf = audioCtx.createBiquadFilter();
subShelf.type = "lowshelf";
subShelf.frequency.value = 70;
subShelf.gain.value = 2.5; // boost ringan

subMidCut = audioCtx.createBiquadFilter();
subMidCut.type = "peaking";
subMidCut.frequency.value = 300; // area muddiness
subMidCut.Q.value = 1.2;
subMidCut.gain.value = -2.5;

subCompressor = audioCtx.createDynamicsCompressor();
subCompressor.threshold.value = -28;
subCompressor.knee.value = 12;
subCompressor.ratio.value = 2.5;
subCompressor.attack.value = 0.005;
subCompressor.release.value = 0.25;

function updateSubGain(kickEnergy) {
  const now = audioCtx.currentTime;
  const targetGain = kickEnergy > 120 ? 0.85 : 1.0;
  subGain.gain.setTargetAtTime(targetGain, now, 0.3);
}

console.log("🧰 Sub Compressor siap:", subCompressor);

console.log("✅ Semua filter EQ bawah berhasil di-set!");

function renderFrame() {
  // Analisis real-time
  const kickEnergy = analyseKick(); // fungsi lo sendiri
  updateSubGain(kickEnergy);

  requestAnimationFrame(renderFrame);
}

  // ✅ Low-shelf filter buat angkat bass
  lowShelf = audioCtx.createBiquadFilter();
  lowShelf.type = 'lowshelf';
  lowShelf.frequency.value = 150;
  lowShelf.gain.value = 3;

// Bass
eqNodes.bass = audioCtx.createBiquadFilter();
eqNodes.bass.type = "lowshelf";
eqNodes.bass.frequency.value = 100;
eqNodes.bass.gain.value = 4;
eqNodes.bass.Q.value = 1;

// Kick
eqNodes.kick = audioCtx.createBiquadFilter();
eqNodes.kick.type = "lowshelf";
eqNodes.kick.frequency.value = 60;
eqNodes.kick.gain.value = 8;
eqNodes.kick.Q.value = 1;

// Snare
eqNodes.snare = audioCtx.createBiquadFilter();
eqNodes.snare.type = "peaking";
eqNodes.snare.frequency.value = 1500;
eqNodes.snare.gain.value = 6;
eqNodes.snare.Q.value = 1;

// Guitar
eqNodes.guitar = audioCtx.createBiquadFilter();
eqNodes.guitar.type = "peaking";
eqNodes.guitar.frequency.value = 800;
eqNodes.guitar.gain.value = 2;
eqNodes.guitar.Q.value = 1;

// Hihat
eqNodes.hihat = audioCtx.createBiquadFilter();
eqNodes.hihat.type = "highshelf";
eqNodes.hihat.frequency.value = 8000;
eqNodes.hihat.gain.value = 4;
eqNodes.hihat.Q.value = 1;

// Piano
eqNodes.piano = audioCtx.createBiquadFilter();
eqNodes.piano.type = "peaking";
eqNodes.piano.frequency.value = 1200;
eqNodes.piano.gain.value = 3;
eqNodes.piano.Q.value = 1;

console.log("✅ EQ Nodes (gain nyata) sudah diinisialisasi:", eqNodes);

pianoEQ = audioCtx.createBiquadFilter();
pianoEQ.type = "peaking";
pianoEQ.frequency.value = 1200;
pianoEQ.Q.value = 0.8;
pianoEQ.gain.value = 3; // clarity & presence

 pianoReverb = audioCtx.createConvolver();
// loadImpulse(pianoReverb, "hall.wav"); // optional: reverb IR

pianoCompressor = audioCtx.createDynamicsCompressor();
pianoCompressor.threshold.value = -40;
pianoCompressor.ratio.value = 4;
pianoCompressor.attack.value = 0.01;
pianoCompressor.release.value = 0.3;

bassEQ = audioCtx.createBiquadFilter();
bassEQ.type = "lowshelf";
bassEQ.frequency.value = 100;
bassEQ.gain.value = 6.5; // empuk bass

midEQ = audioCtx.createBiquadFilter();
midEQ.type = "peaking";
midEQ.frequency.value = 1100;
midEQ.Q.value = 1;
midEQ.gain.value = 2; // bening vokal

trebleEQ = audioCtx.createBiquadFilter();
trebleEQ.type = "highshelf";
trebleEQ.frequency.value = 6000;
trebleEQ.gain.value = 1.5; // crisp & clarity

snareSnap = audioCtx.createBiquadFilter();
snareSnap.type = "peaking";
snareSnap.frequency.value = 5200;   // khusus buat snare crack
snareSnap.Q.value = 3.0;
snareSnap.gain.value = 3.5;

snareCutMud = audioCtx.createBiquadFilter();
snareCutMud.type = "peaking";
snareCutMud.frequency.value = 800; // buang nasal
snareCutMud.Q.value = 2.5;
snareCutMud.gain.value = -3;

snareAttack = audioCtx.createBiquadFilter();
snareAttack.type = "peaking";
snareAttack.frequency.value = 3500;
snareAttack.Q.value = 1.8;
snareAttack.gain.value = 6;

snareCrack = audioCtx.createBiquadFilter();
snareCrack.type = "peaking";
snareCrack.frequency.value = 7500;
snareCrack.Q.value = 1.6;
snareCrack.gain.value = 4;

snareBody = audioCtx.createBiquadFilter();
snareBody.type = "peaking";
snareBody.frequency.value = 200;
snareBody.Q.value = 1.2;
snareBody.gain.value = 3.5;

// Tambah peaking filter khusus snare attack
snareBoost = audioCtx.createBiquadFilter();
snareBoost.type = "peaking";
snareBoost.frequency.value = 3200; // Fokus attack snare
snareBoost.Q.value = 1.5;
snareBoost.gain.value = 4.5;

depBoost = audioCtx.createBiquadFilter();
depBoost.type = "peaking";
depBoost.frequency.value = 90;
depBoost.Q.value = 1;
depBoost.gain.value = 3.5;

mixMidCut = audioCtx.createBiquadFilter();
mixMidCut.type = "peaking";
mixMidCut.frequency.value = 1100; // 950–1200Hz
mixMidCut.Q.value = 1.2;
mixMidCut.gain.value = -3.5; // Mulai dari -3 dB

  // ✅ Peaking filter buat flatten mid kalau perlu
  midCut = audioCtx.createBiquadFilter();
  midCut.type = 'peaking';
  midCut.frequency.value = 1200;
  midCut.Q.value = 1.2;
  midCut.gain.value = -4;

mixAir = audioCtx.createBiquadFilter();
mixAir.type = "highshelf";
mixAir.frequency.value = 9500;
mixAir.Q.value = 0.7;
mixAir.gain.value = 2.0; // 1.5–3 dB cukup

  // ✅ High-shelf filter buat "cut treble"
  highShelf = audioCtx.createBiquadFilter();
  highShelf.type = 'highshelf';
  highShelf.frequency.value = 6000;    // Potong mulai dari 6kHz
  highShelf.gain.value = -6;           // Potong treble 6 dB
  
trebleNotch = audioCtx.createBiquadFilter();
trebleNotch.type = "notch";
trebleNotch.frequency.value = 6500;
trebleNotch.Q.value = 3;

// ?? FX NODES INIT
clarityBoost = audioCtx.createBiquadFilter();
clarityBoost.type = "highshelf";
clarityBoost.frequency.value = 4500;
clarityBoost.gain.value = -2.5;

clarity = audioCtx.createBiquadFilter();
clarity.type = "bandpass";
clarity.frequency.value = 4000;
clarity.Q.value = 2; 
clarity.gain.value = 2;

clarityGain = audioCtx.createGain();
clarityGain.gain.value = 0.7;

guitarSnap = audioCtx.createBiquadFilter();
guitarSnap.type = "peaking";
guitarSnap.frequency.value = 3100;
guitarSnap.Q.value = 2.0;
guitarSnap.gain.value = 3;

enhancer = audioCtx.createBiquadFilter();
enhancer.type = "highshelf";
enhancer.frequency.value = 9000;
enhancer.gain.value = 2;

loudnessLow = audioCtx.createBiquadFilter();
loudnessLow.type = "lowshelf";
loudnessLow.frequency.value = 150;
loudnessLow.gain.value = 3;

loudnessHigh = audioCtx.createBiquadFilter();
loudnessHigh.type = "highshelf";
loudnessHigh.frequency.value = 6000;
loudnessHigh.gain.value = 3;

subwoofer = audioCtx.createBiquadFilter();
subwoofer.type = "lowshelf";
subwoofer.frequency.value = 80;
subwoofer.gain.value = 9;

deEsser = audioCtx.createBiquadFilter();
deEsser.type = "peaking";
deEsser.frequency.value = 7800;
deEsser.Q.value = 3;
deEsser.gain.value = -3.5;

orchestraEQ = audioCtx.createBiquadFilter();
orchestraEQ.type = "peaking";
orchestraEQ.frequency.value = 2500;
orchestraEQ.gain.value = 2; // lift orchestral body

stereoWidener = audioCtx.createStereoPanner();
stereoWidener.pan.value = 0.6;

orchestraReverb = audioCtx.createConvolver();
// loadImpulse(orchestraReverb, "cathedral.wav");

ambient = audioCtx.createBiquadFilter();
ambient.type = "lowpass";
ambient.frequency.value = 15000;
ambient.Q.value = 1.5;

toneBias = audioCtx.createBiquadFilter();
toneBias.type = "peaking";
toneBias.frequency.value = 500;
toneBias.Q.value = 1;
toneBias.gain.value = 1.0;

const high = 5; // ← contoh nilai
const now = audioCtx.currentTime;

// 🔧 Bikin 1 filter peaking manual
biquadFilter = audioCtx.createBiquadFilter();
biquadFilter.type = "peaking";
biquadFilter.frequency.value = 1400;  // frekuensi mid clarity
biquadFilter.Q.value = 1.2;           // lebar frekuensi
biquadFilter.gain.value = 3;        // boost +3.5 dB

biquadFilter.gain.setTargetAtTime(high < 10 ? 2 : 1, now, 0.4);

// 📈 DYNAMICS
compressor = audioCtx.createDynamicsCompressor();
compressor.threshold.value = -50;
compressor.knee.value = 40;
compressor.ratio.value = 12;
compressor.attack.value = 0.003;
compressor.release.value = 0.25;

agcLimiter = audioCtx.createDynamicsCompressor();
agcLimiter.threshold.value = -9;
agcLimiter.knee.value = 8;
agcLimiter.ratio.value = 8;
agcLimiter.attack.value = 0.004;
agcLimiter.release.value = 0.3;

softLimiter = audioCtx.createDynamicsCompressor();
softLimiter.threshold.value = -6;
softLimiter.knee.value = 6;
softLimiter.ratio.value = 4.5;
softLimiter.attack.value = 0.008;
softLimiter.release.value = 0.22;

smartLimiter = audioCtx.createDynamicsCompressor();
smartLimiter.threshold.value = -1;
smartLimiter.knee.value = 4;
smartLimiter.ratio.value = 10;
smartLimiter.attack.value = 0.003;
smartLimiter.release.value = 0.22;

peakLimiter = audioCtx.createDynamicsCompressor();
peakLimiter.threshold.value = -2;
peakLimiter.knee.value = 0;
peakLimiter.ratio.value = 20;
peakLimiter.attack.value = 0.002;
peakLimiter.release.value = 0.1;

console.log("🎧 AudioContext dibuat:", audioCtx);  

console.log("🎛️ Flat EQ nodes (graphic style) dibuat:", eqNodes);  
  
console.log("✅ Parametric EQ nodes (gain nyata) siap:", {  
  bass: eqNodes.bass,  
  kick: eqNodes.kick,  
  snare: eqNodes.snare,  
  guitar: eqNodes.guitar,  
  hihat: eqNodes.hihat,  
  piano: eqNodes.piano  
});  
  
console.log("📈 Dynamics processors initialized:", {  
  compressor,  
  agcLimiter,  
  softLimiter,  
  peakLimiter,  
  smartLimiter  
});  
  
console.log("🎨 FX Filters aktif:", {  
  clarity, guitarSnap, enhancer, toneBias,  
  loudnessLow, loudnessHigh, subwoofer, deEsser  
});  
  
console.log("🌌 Spatial & Reverb units:", {  
  pianoReverb,  
  orchestraReverb,  
  stereoWidener,  
  ambient  
});  

function logInfo(label, obj) {  
  console.log(`ℹ️ ${label}:`, obj);  
}  
  
logInfo("Dynamics", { compressor, smartLimiter });

    // 🔊 Gain & Booster
    boosterGainNode = audioCtx.createGain(); boosterGainNode.gain.value = 1.05;
    gainNode = audioCtx.createGain(); gainNode.gain.value = 0.82;
  
    // 🎧 Stereo & Analyzer
    stereoPanner = audioCtx.createStereoPanner();
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;

    // 🎼 PowerAmp & Harmonic AI (optional)
    // Buat node-nya sebelumnya (powerAmpNode & harmonicAIEngine) kalau belum

    console.log("🔗 Building initAudioContext");
    
            // ====== 🔀 Chain Setup ======
    let current = sourceNode;

// EQ Slider 12-band
if (eqNodes?.length) {
  eqNodes.forEach(node => {
    current = node;
  });
  console.log(`🎚️ EQ Connected (${eqNodes.length} bands)`);
}

// FX Chain
const fxChain = [
  subwoofer,
  loudnessLow,
  toneBias,
  enhancer,
  loudnessHigh,
  deEsser,
  ambient,
];

console.log("🎛️ FX Chain Connected");
    
    function connectChain(nodes) {
  for (let i = 0; i < nodes.length - 1; i++) {
    if (nodes[i] && nodes[i + 1]) {
      nodes[i].connect(nodes[i + 1]);
    }
  }
}

function buildSubwooferChain(audioCtx, inputNode) {
  const lowCut = audioCtx.createBiquadFilter();
  const shelf = audioCtx.createBiquadFilter();
  const midCut = audioCtx.createBiquadFilter();
  const comp = audioCtx.createDynamicsCompressor();

  inputNode.connect(lowCut);
  lowCut.connect(shelf);
  shelf.connect(midCut);
  midCut.connect(comp);

  return comp; // ujung chain
}

connectChain([
  snareBody,
  snareCutMud,
  snareBoost,
  snareAttack,
  snareSnap,
  snareCrack,
]);

connectChain([
  eqNodes.guitar,
  guitarSnap,
  enhancer,
  stereoWidener,
]);

connectChain([
  pianoEQ,
  clarity,
  clarityGain,
  pianoCompressor,
  pianoReverb, // optional
]);

connectChain([
  eqNodes.kick,
  depBoost,
  subwoofer,
]);

connectChain([
  eqNodes.bass,
  bassEQ,
]);

connectChain([
  orchestraEQ,
  stereoWidener,
  orchestraReverb, // optional
]);

connectChain([
  midEQ,
  trebleEQ,
  toneBias,
  biquadFilter,
]);

// Dynamics Chain
current.connect(compressor);
compressor.connect(agcLimiter);
agcLimiter.connect(softLimiter);
softLimiter.connect(peakLimiter);
peakLimiter.connect(smartLimiter);
current = smartLimiter;
console.log("🧰 Dynamics Connected");


// PowerAmp (optional)
if (!powerAmpNode) {
  console.log("⏳ PowerAmp ready...");
  injectPowerAmpV2(); // injeksi dulu
}

if (powerAmpNode && typeof powerAmpNode.connect === "function") {
  current.connect(powerAmpNode);
}  
  console.log("⚡ PowerAmp Connected!");

// Final Gain Stage
current.connect(boosterGainNode);
boosterGainNode.connect(gainNode);
gainNode.connect(stereoPanner);
stereoPanner.connect(analyser);
analyser.connect(audioCtx.destination);

    // Harmonic AI
    if (typeof harmonicAIEngine !== "undefined") {
      current.connect(harmonicAIEngine);
      current = harmonicAIEngine;
      console.log("🎼 Harmonic AI Engine Applied");
    }

    // Booster Gain
    current.connect(boosterGainNode);
    current = boosterGainNode;
    console.log("🚀 Booster Gain Applied");

    // Final Gain
    current.connect(gainNode);
    current = gainNode;
    console.log("🔊 Final Gain Applied");

    // Stereo Panner
    current.connect(stereoPanner);
    current = stereoPanner;
    console.log("🎧 Stereo Panner Applied");


    // Analyser
    current.connect(analyser);
    current = analyser;
    console.log("📈 Analyser Connected");

    // Final Output
    current.connect(audioCtx.destination);
    console.log("🔊 Audio Connected to Destination");

    // Final Output
    current.connect(audioCtx.destination);
    console.log("🔊 Audio Connected to Destination");
      startSlowPan;
      console.log("🌀 Stereo Motion Enabled");

    setTimeout(() => {
  autoInjectHarmonicEnhancerV2();
}, 1000); // kasih delay dikit biar audioCtx stabil dulu

function autoInjectHarmonicEnhancerV2() {
  if (!audioCtx || !analyser) return;

  const enhancerNodes = [];
  const harmonicBus = audioCtx.createGain();
  harmonicBus.gain.value = 0.7;

  // Inject ke bus mastering, bukan ke destination langsung
  harmonicBus.connect(softLimiter || gainNode || audioCtx.destination);

// ✅ ini baru
const tones = [
  { freq: 55, type: "sine", baseGain: 0.012 },
  { freq: 110, type: "sine", baseGain: 0.015 },
  { freq: 220, type: "triangle", baseGain: 0.013 },
  { freq: 440, type: "triangle", baseGain: 0.012 },
  { freq: 880, type: "square", baseGain: 0.01 },
  { freq: 14000, type: "sine", baseGain: 0.008 }
];

  tones.forEach(t => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = t.type;
    osc.frequency.value = t.freq;
    gain.gain.value = 0;

    osc.connect(gain);
    gain.connect(harmonicBus);
    osc.start();

    enhancerNodes.push({ osc, gain, baseGain: t.baseGain });

    // Auto stop & restart setiap 10 detik (hemat CPU)
    setTimeout(() => {
      try {
        osc.stop();
      } catch {}
    }, 10000);

    setTimeout(() => {
      if (audioCtx.state === "running") {
        const oscNew = audioCtx.createOscillator();
        oscNew.type = t.type;
        oscNew.frequency.value = t.freq;
        const gainNew = audioCtx.createGain();
        gainNew.gain.value = gain.gain.value;

        oscNew.connect(gainNew).connect(harmonicBus);
        oscNew.start();

        enhancerNodes.push({ osc: oscNew, gain: gainNew, baseGain: t.baseGain });
      }
    }, 10500);
  });

  window.harmonicEnhancerNodes = enhancerNodes;

  function updateHarmonicEnhancer() {
    const freqData = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(freqData);

    const mid = freqData.slice(60, 180).reduce((a, b) => a + b, 0) / 120;
    const high = freqData.slice(180).reduce((a, b) => a + b, 0) / (freqData.length - 180);
    const scale = Math.min(1.1, (mid + high) / 180);

    enhancerNodes.forEach(node => {
      const target = node.baseGain * scale;
      node.gain.gain.setTargetAtTime(target, audioCtx.currentTime, 0.5);
    });
  }

  window.updateHarmonicEnhancer = updateHarmonicEnhancer;
  console.log("🌈 Harmonic Enhancer V2.1 injected (auto cycle, adaptive, no freeze)");
}

async function injectPowerAmpV2() {
  const code = `
    class PowerAmpProcessor extends AudioWorkletProcessor {
      static get parameterDescriptors() {
        return [
          { name: 'gain', defaultValue: 3.5, minValue: 1.0, maxValue: 10.0 },
          { name: 'drive', defaultValue: 0.6, minValue: 0.0, maxValue: 1.0 },
          { name: 'mode', defaultValue: 3.0 }
        ];
      }

      process(inputs, outputs, parameters) {
        const input = inputs[0];
        const output = outputs[0];
        const gain = parameters.gain;
        const drive = parameters.drive;
        const mode = parameters.mode[0];

        for (let channel = 0; channel < input.length; channel++) {
          const inCh = input[channel];
          const outCh = output[channel];

          for (let i = 0; i < inCh.length; i++) {
            let val = inCh[i];
            let g = gain.length > 1 ? gain[i] : gain[0];
            let d = drive.length > 1 ? drive[i] : drive[0];

            val *= g;
            if (Math.abs(val) > 0.8) d *= 0.65;

            let shaped = Math.atan(val * (1 + d * 2)) / Math.atan(1 + d * 2);

            // === MODE SWITCH ===
            if (mode === 0) {
              shaped *= 0.75;
            }
            if (mode === 1) {
              shaped = shaped * 0.9 + 0.12 * Math.pow(shaped, 3);
            }
            if (mode === 2) {
              shaped = shaped * 1.2 + 0.08 * Math.sin(i * 0.03);
            }
            if (mode === 3) {
              shaped = shaped * 1.12 + 0.04 * Math.sin(i * 0.05);
            }
            if (mode === 6) {
              shaped = shaped * 1.05 + 0.01 * Math.sin(i * 0.2) + 0.005 * Math.sin(i * 0.8);
            }
            if (mode === 9) {
              if (val < 0) shaped = val * 1.1;
              else shaped = val * 1.25 + 0.02 * Math.sin(i * 0.03);
            }
            if (mode === 11) {
              shaped = shaped * (1 + 0.01 * Math.sin(i * 0.1 + channel));
            }

            outCh[i] = shaped;
          }
        }
        return true;
      }
    }

    registerProcessor('power-amp-processor', PowerAmpProcessor);
  `;

 const blob = new Blob([code], { type: 'application/javascript' });
  const blobURL = URL.createObjectURL(blob);

  // Clean-up lama
  if (powerAmpNode) {
    try {
      powerAmpNode.disconnect();
    } catch {}
    powerAmpNode = null;
  }

  try {
    await audioCtx.audioWorklet.addModule(blobURL);
    console.log("✅ PowerAmp module registered");

    powerAmpNode = new AudioWorkletNode(audioCtx, 'power-amp-processor');

    powerAmpNode.parameters.get('gain').value = 1;
    powerAmpNode.parameters.get('drive').value = 0.2;
    powerAmpNode.parameters.get('mode').value = 1;

    console.log("🎛️ PowerAmp v2 injected + parameters set!");
  } catch (err) {
    console.error("❌ Failed to inject PowerAmp:", err);
  }
}

function startAllAIModesAndVisualizer() {
  if (
    !analyser || !clarityGain || !clarity || !subwoofer || !enhancer ||
    !toneBias || !deEsser || !ambient || !loudnessLow || !stereoPanner
  ) {
    console.warn("❌ Audio nodes belum lengkap.");
    return;
  }

  const freqData = new Uint8Array(analyser.frequencyBinCount);
  const timeData = new Uint8Array(analyser.fftSize);

  function avg(data, from, to) {
    let sum = 0;
    for (let i = from; i < to; i++) sum += data[i];
    return sum / (to - from);
  }

  function loop() {
    analyser.getByteFrequencyData(freqData);
    analyser.getByteTimeDomainData(timeData);

    const low = avg(freqData, 0, 40);
    const mid = avg(freqData, 41, 180);
    const high = avg(freqData, 181, 512);
    const total = low + mid + high || 1;

    const lowRatio = low / total;
    const midRatio = mid / total;
    const highRatio = high / total;
    const now = audioCtx.currentTime;
    
  window.AIModeStatus = {
  timbre: false,
  transparency: false,
  harmonicEnhancer: false,
  stereoPan: false,
  shimmer: false
};

    // === 🎛 Dynamic Tone AI ===
    subwoofer.gain.setTargetAtTime(2.2 + Math.max(0, Math.min(1, (lowRatio - 0.3) / 0.3)) * 3.6, now, 0.6);
    loudnessLow.gain.setTargetAtTime(lowRatio > 0.38 ? 3.2 : 1.6, now, 0.6);
    clarityGain.gain.setTargetAtTime(mid < 15 ? 0.9 : 0.6, now, 0.4);
    clarity.gain.setTargetAtTime(mid < 15 ? 3.2 : 1.6, now, 0.4);
    enhancer.gain.setTargetAtTime(highRatio > 0.4 ? 0.2 : 2.6, now, 0.6);
    toneBias.gain.setTargetAtTime(midRatio < 0.25 ? 2.2 : 1.1, now, 0.5);
    deEsser.gain.setTargetAtTime(highRatio > 0.42 ? -6.5 : -4, now, 0.4);
    ambient.frequency.setTargetAtTime(6000 + Math.max(0, Math.min(1, (high - 14) / 6)) * 6000, now, 0.5);
    ambient.Q.setTargetAtTime(1.4 - Math.max(0, Math.min(1, (high - 14) / 6)) * 0.75, now, 0.5);
    
    window.AIModeStatus.harmonicEnhancer = true;

    // === 🎨 Timbre AI Mode ===
    clarity.Q.setTargetAtTime(mid > 20 ? 1.2 : 0.8, now, 0.6);
    clarity.frequency.setTargetAtTime(mid < 25 ? 3400 : 4000, now, 0.6);
    clarityGain.gain.setTargetAtTime(mid > 25 ? 0.75 : 0.6, now, 0.6);
    toneBias.gain.setTargetAtTime(mid < 18 ? 2.0 : 1.2, now, 0.5);
    enhancer.gain.setTargetAtTime(high > 28 ? 2.8 : 1.5, now, 0.5);
    
    window.AIModeStatus.timbre = true;

    // === 🔍 Transparent Mix Mode ===
    toneBias.gain.setTargetAtTime(mid > 35 ? 0.9 : 1.3, now, 0.3);
    clarityGain.gain.setTargetAtTime(mid > 50 ? 0.55 : 0.7, now, 0.3);
    clarity.Q.setTargetAtTime(1.2, now, 0.3);
    clarityGain.gain.setTargetAtTime(mid > 50 ? 0.55 : 0.7, now, 0.3);
    deEsser.gain.setTargetAtTime(high > 35 ? -5.5 : -3.5, now, 0.2);
    
    window.AIModeStatus.transparency = true;

    // === 🌀 Stereo Widening
    if (typeof stereoToggleState !== 'undefined' && stereoToggleState) {
      stereoPanner.pan.setTargetAtTime(Math.sin(Date.now() / 2000) * 0.15, now, 0.3);
    }
    
    window.AIModeStatus.stereoPan = true;

    // === ✨ Final Polish
    toneBias.gain.setTargetAtTime(mid > 40 ? 1 : 1.4, now, 0.4);
    clarityGain.gain.setTargetAtTime(mid > 50 ? 0.55 : 0.7, now, 0.3);
    deEsser.gain.setTargetAtTime(high > 42 ? -5.5 : -3.5, now, 0.25);

// === 🌈 Optional: Simulasi Pitch Fluctuation (analog shimmer)
const pitchFluct = Math.sin(now * 0.8) * 20 + Math.sin(now * 1.7) * 12;
clarity.frequency.setTargetAtTime(4000 + pitchFluct, now, 0.4);

lastPitchFluct = pitchFluct;

window.AIModeStatus.shimmer = true;

// Optional shimmer stereo mod
if (typeof stereoToggleState !== 'undefined' && stereoToggleState) {
  const shimmer = Math.sin(now * 1.3) * 0.18;
  stereoPanner.pan.setTargetAtTime(shimmer, now, 0.25);
}

    // === 🎨 Visualizer
function drawAllVisuals() {
  requestAnimationFrame(drawAllVisuals);
  if (!audioCtx || audioCtx.state !== "running") return;

  // ✅ Peak meters & shimmer aman...

  // 🌈 Waveform Visualizer
  if (typeof drawWaveform === "function") {
    drawWaveform(analyser); // ✅ loop terus
  }
}

    requestAnimationFrame(loop);
  }

  loop();
  console.log("✅ All AI & Visualizer Loop Started");
}

    try {
      startAllAIModesAndVisualizer();
      console.log("✨ startAllAIModesAndVisualizer");
    } catch (err) {
      console.warn("❌ AI Engine gagal:", err.message);
    }


    console.log("✅ initAudioContext Finalized [EQ ➝ FX ➝ Dynamics ➝ Harmonic ➝ PowerAmp ➝ AI ➝ Gain ➝ Stereo ➝ Out]");

    console.log("⏳ AudioContext already initialized");


    
    // === Render dan auto-download 16-bit + 32-bit WAV
async function render32bitAudio(durationInSec = 10) {
  const sampleRate = audioCtx?.sampleRate || 44100;
  const srcBuffer = window.lastRenderedBuffer;
  if (!srcBuffer) return log("❌ Buffer tidak ditemukan");

  const offlineCtx = new OfflineAudioContext(2, durationInSec * sampleRate, sampleRate);
  const source = offlineCtx.createBufferSource();
  source.buffer = srcBuffer;

  // FX Chain
  const snap = offlineCtx.createBiquadFilter();
  snap.type = "peaking"; snap.frequency.value = 2100; snap.gain.value = 4; snap.Q.value = 1.2;

  const clarity = offlineCtx.createBiquadFilter();
  clarity.type = "highshelf"; clarity.frequency.value = 4800; clarity.gain.value = 3;

  const boost = offlineCtx.createGain();
  boost.gain.value = 1.25;

  source.connect(snap).connect(clarity).connect(boost).connect(offlineCtx.destination);
  source.start();

  log("🎛️ [Render] Mulai render...");
  const renderedBuffer = await offlineCtx.startRendering();

  const wav16 = encodeWAV16bit(renderedBuffer);
  const wav32 = encodeWAVFloat32(renderedBuffer);

  autoDownload(wav16, "rendered-16bit.wav");
  autoDownload(wav32, "rendered-32bit-float.wav");

  log("✅ Render dan download selesai");
}

function autoDownload(blob, filename) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    document.body.removeChild(a);
  }, 1000);
}

// === Encode WAV 16-bit PCM
function encodeWAV16bit(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 2;
  const wav = new DataView(new ArrayBuffer(44 + length));
  let offset = 0;

  function writeString(s) {
    for (let i = 0; i < s.length; i++) wav.setUint8(offset++, s.charCodeAt(i));
  }

  function floatTo16bitPCM(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, input[i]));
      s = s < 0 ? s * 0x8000 : s * 0x7FFF;
      output.setInt16(offset, s, true);
    }
  }

  writeString("RIFF"); wav.setUint32(offset, 36 + length, true); offset += 4;
  writeString("WAVE"); writeString("fmt "); wav.setUint32(offset, 16, true); offset += 4;
  wav.setUint16(offset, 1, true); offset += 2;
  wav.setUint16(offset, numChannels, true); offset += 2;
  wav.setUint32(offset, sampleRate, true); offset += 4;
  wav.setUint32(offset, sampleRate * numChannels * 2, true); offset += 4;
  wav.setUint16(offset, numChannels * 2, true); offset += 2;
  wav.setUint16(offset, 16, true); offset += 2;
  writeString("data"); wav.setUint32(offset, length, true); offset += 4;

  for (let ch = 0; ch < numChannels; ch++) {
    floatTo16bitPCM(wav, offset + ch * 2, buffer.getChannelData(ch));
  }

  return new Blob([wav], { type: "audio/wav" });
}

// === Encode WAV 32-bit Float
function encodeWAVFloat32(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 4;
  const wav = new DataView(new ArrayBuffer(44 + length));
  let offset = 0;

  function writeString(s) {
    for (let i = 0; i < s.length; i++) wav.setUint8(offset++, s.charCodeAt(i));
  }

  function writeFloat32(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 4) {
      output.setFloat32(offset, input[i], true);
    }
  }

  writeString("RIFF"); wav.setUint32(offset, 36 + length, true); offset += 4;
  writeString("WAVE"); writeString("fmt "); wav.setUint32(offset, 16, true); offset += 4;
  wav.setUint16(offset, 3, true); offset += 2; // Format 3 = float
  wav.setUint16(offset, numChannels, true); offset += 2;
  wav.setUint32(offset, sampleRate, true); offset += 4;
  wav.setUint32(offset, sampleRate * numChannels * 4, true); offset += 4;
  wav.setUint16(offset, numChannels * 4, true); offset += 2;
  wav.setUint16(offset, 32, true); offset += 2;
  writeString("data"); wav.setUint32(offset, length, true); offset += 4;

  for (let ch = 0; ch < numChannels; ch++) {
    writeFloat32(wav, offset + ch * 4, buffer.getChannelData(ch));
  }

  return new Blob([wav], { type: "audio/wav" });
}

// Log helper
function log(msg) {
  console.log(msg);
  const div = document.getElementById("statusLog");
  if (div) {
    const line = document.createElement("div");
    line.textContent = msg;
    div.appendChild(line);
  }
}
    
    // === Encode WAV 24-bit PCM
function encodeWAV24bit(buffer) {
  const numChannels = buffer.numberOfChannels;
  const sampleRate = buffer.sampleRate;
  const length = buffer.length * numChannels * 3; // 3 bytes per sample
  const wav = new DataView(new ArrayBuffer(44 + length));
  let offset = 0;

  function writeString(s) {
    for (let i = 0; i < s.length; i++) wav.setUint8(offset++, s.charCodeAt(i));
  }

  function floatTo24bitPCM(output, offset, input) {
    for (let i = 0; i < input.length; i++, offset += 3) {
      let s = Math.max(-1, Math.min(1, input[i]));
      let int = Math.floor(s * 8388607); // 2^23 - 1
      output.setUint8(offset, int & 0xFF);         // low byte
      output.setUint8(offset + 1, (int >> 8) & 0xFF);  // mid byte
      output.setUint8(offset + 2, (int >> 16) & 0xFF); // high byte
    }
  }

  writeString("RIFF"); wav.setUint32(offset, 36 + length, true); offset += 4;
  writeString("WAVE"); writeString("fmt "); wav.setUint32(offset, 16, true); offset += 4;
  wav.setUint16(offset, 1, true); offset += 2; // PCM format
  wav.setUint16(offset, numChannels, true); offset += 2;
  wav.setUint32(offset, sampleRate, true); offset += 4;
  wav.setUint32(offset, sampleRate * numChannels * 3, true); offset += 4; // byteRate
  wav.setUint16(offset, numChannels * 3, true); offset += 2; // blockAlign
  wav.setUint16(offset, 24, true); offset += 2; // bitsPerSample
  writeString("data"); wav.setUint32(offset, length, true); offset += 4;

  // Tulis sample tiap channel
  for (let ch = 0; ch < numChannels; ch++) {
    floatTo24bitPCM(wav, offset + ch * 3, buffer.getChannelData(ch));
  }
  
    return new Blob([wav], { type: "audio/wav" });
}

function renderAllBitDepth(durationInSec = 10) {
  const sampleRate = audioCtx?.sampleRate || 44100;
  const srcBuffer = window.lastRenderedBuffer;
  if (!srcBuffer) return log("❌ Buffer tidak ditemukan");

  const offlineCtx = new OfflineAudioContext(2, durationInSec * sampleRate, sampleRate);
  const source = offlineCtx.createBufferSource();
  source.buffer = srcBuffer;

  // FX Chain
  const snap = offlineCtx.createBiquadFilter();
  snap.type = "peaking"; snap.frequency.value = 2100; snap.gain.value = 4; snap.Q.value = 1.2;

  const clarity = offlineCtx.createBiquadFilter();
  clarity.type = "highshelf"; clarity.frequency.value = 4800; clarity.gain.value = 3;

  const boost = offlineCtx.createGain();
  boost.gain.value = 1.25;

  source.connect(snap).connect(clarity).connect(boost).connect(offlineCtx.destination);
  source.start();

  log("🎛️ [Render] Mulai render...");

  offlineCtx.startRendering().then(renderedBuffer => {
    const wav16 = encodeWAV16bit(renderedBuffer);
    const wav24 = encodeWAV24bit(renderedBuffer);
    const wav32 = encodeWAVFloat32(renderedBuffer);

    autoDownload(wav16, "rendered-16bit.wav");
    autoDownload(wav24, "rendered-24bit.wav");
    autoDownload(wav32, "rendered-32bit-float.wav");

    log("✅ Render & download semua format selesai");
  }).catch(err => log("❌ Gagal render: " + err.message));
}

    window.lastRender16BitOK = true;
    window.lastRender24BitOK = true;
    window.lastRender32BitOK = true;


bands = [10, 32, 64, 125, 250, 500, 1000, 2000, 4000, 10000, 16000, 20000];
    const eqPresets = {
  "Flat":  {
    eq: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    enhancer: { presence: 0, brilliance: 0, warmth: 0 },
    compressor: { threshold: -12, ratio: 2, attack: 0.003, release: 0.25 },
    limiter: { threshold: -3, ratio: 10, attack: 0.002, release: 0.1 },
    stereoWidth: 1,
    reverb: 0
  },
  "Bass Boost":  {
    eq: [5, 4, 3, 1, 0, -1, -2, -2, -3, -3, -4, -5],
    enhancer: { presence: 0.2, brilliance: 0.1, warmth: 0.5 },
    compressor: { threshold: -10, ratio: 3, attack: 0.004, release: 0.3 },
    limiter: { threshold: -2, ratio: 8, attack: 0.003, release: 0.2 },
    stereoWidth: 1.1,
    reverb: 0.1
  },
  "Treble Boost": {
    eq: [-3, -2, -2, -1, 0, 1, 2, 3, 4, 5, 5, 6],
    enhancer: { presence: 0.3, brilliance: 0.6, warmth: 0.1 },
    compressor: { threshold: -11, ratio: 2.8, attack: 0.0025, release: 0.22 },
    limiter: { threshold: -2.5, ratio: 9, attack: 0.002, release: 0.1 },
    stereoWidth: 1.05,
    reverb: 0.05
  },
"Rock": {
  eq: [4.2, 4.0, 3.6, 2.2, 0.3, -1.0, 1.0, 2.6, 3.9, 4.5, 4.2, 3.2],
  enhancer: { presence: 0.85, brilliance: 0.55, warmth: 0.5 },
  compressor: { threshold: -11, ratio: 4.0, attack: 4, release: 68 },
  limiter: { threshold: -3.5, ratio: 10.5, attack: 0.003, release: 0.11 },
  stereoWidth: 1.3,
  reverb: 0.21
},
"Pop": {
  eq: [2.5, 2.2, 1.8, 0.8, 0, -0.8, 0.2, 1.2, 2.0, 2.5, 2.2, 1.8],
  enhancer:   { presence: 0.5, brilliance: 0.3, warmth: 0.6 },
  compressor: { threshold: -15, ratio: 2.8, attack: 5, release: 70 },
  limiter:    { threshold: -6,  ratio: 7, attack: 0.005, release: 0.17 },
  stereoWidth: 1.0,
  reverb: 0.22
},
"Jazz": {
  eq: [1.5, 1.2, 1, 0.5, 0.2, 0, 0.3, 0.5, 1, 1.3, 1.1, 1],
  enhancer: { presence: 0.4, brilliance: 0.2, warmth: 0.5 },
  compressor: { threshold: -18, ratio: 2, attack: 12, release: 120 },
  limiter:    { threshold: -7, ratio: 4, attack: 0.008, release: 0.3 },
  stereoWidth: 1.0,
  reverb: 0.15
},
"Classic": {
  eq: [1.2, 1, 0.8, 0.5, 0, -0.5, -0.8, 0.3, 0.6, 1.1, 1, 0.8],
  enhancer: {
    presence: 0.15,
    brilliance: 0.2,
    warmth: 0.7
  },
  compressor: {
    threshold: -18,
    ratio: 2.2,
    attack: 15,
    release: 180
  },
  limiter: {
    threshold: -8,
    ratio: 4,
    attack: 0.005,
    release: 0.35
  },
  stereoWidth: 0.95,   // Sedikit lebih sempit biar fokus ke tengah
  reverb: 0.6           // Lebih besar, biar ambience ruangan terasa
},
"Dance":  {
  eq: [4.5, 3.5, 2.5, 1.5, 0, -1, 0.5, 1.5, 3, 4, 3.5, 2.5],
  enhancer: {
    presence: 0.7,
    brilliance: 0.5,
    warmth: 0.6
  },
  compressor: {
    threshold: -11,
    ratio: 3.5,
    attack: 4,
    release: 80
  },
  limiter: {
    threshold: -5,
    ratio: 9,
    attack: 0.004,
    release: 0.15
  },
  stereoWidth: 1.15,
  reverb: 0.08
},
"Chill Vibe": {
  eq: [2.8, 2.4, 2, 1.5, 0.2, -0.7, 0.3, 1.2, 2, 2.5, 2.2, 1.8],
  enhancer:   { presence: 0.5, brilliance: 0.3, warmth: 0.6 },
  compressor: { threshold: -13, ratio: 2.7, attack: 5, release: 70 },
  limiter:    { threshold: -6, ratio: 7, attack: 0.004, release: 0.18 },
  stereoWidth: 1.1,
  reverb: 0.25
},
"Live Acoustic": {
  eq: [2.5, 2.2, 1.8, 1, 0, -1.2, -0.5, 0.5, 1.2, 2.2, 2.8, 2.5],
  enhancer: { presence: 0.5, brilliance: 0.3, warmth: 0.7 },
  compressor: { threshold: -13, ratio: 2.8, attack: 4, release: 55 },
  limiter: { threshold: -5, ratio: 6.5, attack: 0.004, release: 0.1 },
  stereoWidth: 1.05,
  reverb: 0.22
},
"DangdutRemix": {  
  eq: [4.5, 4.2, 3.5, 2.5, 0.8, -1, 0.8, 2.2, 3.2, 3.8, 3.5, 2.9],  
  enhancer: { presence: 0.8, brilliance: 0.6, warmth: 0.9 },  
  compressor: { threshold: -10, ratio: 3.8, attack: 3, release: 55 },  
  limiter:    { threshold: -3.5, ratio: 9, attack: 0.003, release: 0.12 },  
  stereoWidth: 1.3,  
  reverb: 0.15  
},
"Bright Mix": {  
  eq: [2.8, 2.5, 2, 1.2, 0.5, 0, 0.5, 1.5, 2.8, 3, 2.8, 2.4],  
  enhancer:   { presence: 0.7, brilliance: 0.8, warmth: 0.3 },  
  compressor: { threshold: -14, ratio: 2.5, attack: 3.5, release: 80 },  
  limiter:    { threshold: -4, ratio: 7, attack: 0.004, release: 0.18 },  
  stereoWidth: 1.25,  
  reverb: 0.09  
},  
"Ballad Soft": {
  "eq": [1.5, 1.2, 0.8, 0.3, -0.5, -1, -0.3, 0.5, 1, 1.8, 2, 2.2],
  "enhancer": { "presence": 0.4, "brilliance": 0.2, "warmth": 0.6 },
  "compressor": { "threshold": -14, "ratio": 2.5, "attack": 10, "release": 120 },
  "limiter": { "threshold": -7, "ratio": 5, "attack": 0.005, "release": 0.25 },
  "stereoWidth": 1.05,
  "reverb": 0.18
},
"EDM Festival": {
  eq: [6.5, 5.5, 4.5, 2.5, 0.8, -2, 0, 3, 5.5, 6, 5.2, 4.5],
  enhancer: {
    presence: 1.0,
    brilliance: 0.8,
    warmth: 0.5
  },
  compressor: {
    threshold: -6,
    ratio: 6,
    attack: 3,
    release: 60
  },
  limiter: {
    threshold: -2.5,
    ratio: 10,
    attack: 0.001,
    release: 0.1
  },
  stereoWidth: 1.4,
  reverb: 0.12
},
  "R&B":  {
  eq: [3.2, 2.8, 2.4, 1.6, 0.2, -0.6, 0.4, 1.8, 2.6, 3.2, 3.4, 3],
  enhancer:   { presence: 0.85, brilliance: 0.65, warmth: 0.7 },
  compressor: { threshold: -11, ratio: 3.2, attack: 4.5, release: 58 },
  limiter:    { threshold: -3.8, ratio: 8.5, attack: 0.003, release: 0.12 },
  stereoWidth: 1.35,
  reverb: 0.14
},
"Orchestra": {
  eq: [2.5, 2, 1.5, 1, 0, -0.5, 0.3, 1.2, 2, 2.8, 3, 2.2],
  enhancer:   { presence: 0.5, brilliance: 0.4, warmth: 0.6 },
  compressor: { threshold: -16, ratio: 2.5, attack: 6, release: 90 },
  limiter:    { threshold: -6, ratio: 6.5, attack: 0.005, release: 0.25 },
  stereoWidth: 1.05,
  reverb: 0.3
},
  "Reggae Vibe": {
    eq: [3, 2.8, 2.2, 1.2, 0, -1, 0.6, 1.5, 2.8, 3.5, 3.2, 2.5],
    enhancer:   { presence: 0.6, brilliance: 0.3, warmth: 0.7 },
    compressor: { threshold: -14, ratio: 3, attack: 4, release: 60 },
    limiter:    { threshold: -5, ratio: 7, attack: 0.004, release: 0.2 },
    stereoWidth: 1.1,
    reverb: 0.17
  },
  "Metal Attack": {
    eq: [5.5, 5, 4.2, 2.5, 0, -2, 1.8, 3.2, 4.5, 5.2, 5, 4],
    enhancer:   { presence: 1, brilliance: 0.6, warmth: 0.3 },
    compressor: { threshold: -9, ratio: 4.5, attack: 2, release: 50 },
    limiter:    { threshold: -3, ratio: 10, attack: 0.003, release: 0.15 },
    stereoWidth: 1.15,
    reverb: 0.12
  },
"Shape": {  
  eq: [2.5, 2, 1.5, 0.5, 0, -1, -0.5, 0.2, 1.2, 2, 2.5, 2.2],  
  enhancer:   { presence: 0.6, brilliance: 0.4, warmth: 0.7 },  
  compressor: { threshold: -12, ratio: 3.3, attack: 6, release: 70 },  
  limiter:    { threshold: -4.5, ratio: 8.8, attack: 0.004, release: 0.14 },  
  stereoWidth: 1.1,  
  reverb: 0.1  
},  
  "Podcast Clarity": {
    eq: [1.5, 1.2, 1, 0.5, 0, -0.2, 0.3, 0.8, 1.2, 1.5, 1.2, 1],
    enhancer:   { presence: 0.7, brilliance: 0.6, warmth: 0.2 },
    compressor: { threshold: -18, ratio: 2.2, attack: 4, release: 85 },
    limiter:    { threshold: -4, ratio: 8, attack: 0.004, release: 0.18 },
    stereoWidth: 1,
    reverb: 0.05
  },
  "Surround Deep": {
  eq: [2, 1.8, 1.5, 1, -1.2, -1.5, -1.2, 0.5, 2.5, 3, 2.8, 2.2],
  enhancer: { presence: 0.5, brilliance: 0.4, warmth: 0.6 },
  compressor: { threshold: -13, ratio: 3.5, attack: 4, release: 65 },
  limiter: { threshold: -5.5, ratio: 9, attack: 0.004, release: 0.12 },
  stereoWidth: 1.8,
  reverb: 0.4,
  reflections: { delayL: 11, delayR: 17, feedback: 0.2, wet: 0.25 },
  crossfeed: 0.22
  },
"Sub Bass Lift": {
  eq: [5, 4.5, 3.8, 2.2, 0.5, -1, -1.5, -2, -1.2, -0.5, 0.2, 1],
  enhancer:   { presence: 0.4, brilliance: 0.2, warmth: 0.6 },
  compressor: { threshold: -12, ratio: 3.8, attack: 3, release: 60 },
  limiter:    { threshold: -5, ratio: 7.5, attack: 0.003, release: 0.12 },
  stereoWidth: 1.05,
  reverb: 0.1
},
"Vocal Airy Bright": {
  "eq": [0, 0.5, 1, 1.8, 2.4, 3.2, 3.5, 3, 2, 1, 0.5, 0],
  "enhancer": { "presence": 0.9, "brilliance": 0.85, "warmth": 0.2 },
  "compressor": { "threshold": -18, "ratio": 2.8, "attack": 3, "release": 60 },
  "limiter": { "threshold": -5.5, "ratio": 7, "attack": 0.003, "release": 0.18 },
  "stereoWidth": 1.15,
  "reverb": 0.12
},
"Treble Sparkle": {
  eq: [-2, -1.5, -1, 0, 0.5, 1, 2.5, 3.5, 4.2, 4.5, 4.2, 3.8],
  enhancer:   { presence: 0.6, brilliance: 0.85, warmth: 0.2 },
  compressor: { threshold: -14, ratio: 2.8, attack: 3, release: 65 },
  limiter:    { threshold: -5, ratio: 7, attack: 0.0035, release: 0.15 },
  stereoWidth: 1.15,
  reverb: 0.1
},
"Hi-Fi Wide Range": {
  eq: [3, 2.8, 2.5, 2, 1.5, 0, -0.2, 1, 2, 2.8, 3.2, 3.5],
  enhancer:   { presence: 0.75, brilliance: 0.65, warmth: 0.5 },
  compressor: { threshold: -13, ratio: 3, attack: 3.5, release: 80 },
  limiter:    { threshold: -4.5, ratio: 8.5, attack: 0.003, release: 0.18 },
  stereoWidth: 1.25,
  reverb: 0.14
},
"Warm & Wide": {
  eq: [2.5, 2.2, 1.8, 1.5, 1, 0, 0.5, 1.2, 2.5, 2.8, 2.5, 2],
  enhancer:   { presence: 0.5, brilliance: 0.4, warmth: 0.85 },
  compressor: { threshold: -15, ratio: 2.6, attack: 4.5, release: 85 },
  limiter:    { threshold: -5.5, ratio: 7.5, attack: 0.004, release: 0.2 },
  stereoWidth: 1.3,
  reverb: 0.2
},
"Clarity Focus": {
  eq: [1.8, 1.5, 1.2, 0.8, 0, -0.3, 0.4, 0.9, 1.5, 2.2, 2, 1.6],
  enhancer:   { presence: 0.8, brilliance: 0.6, warmth: 0.3 },
  compressor: { threshold: -17, ratio: 2.5, attack: 4, release: 90 },
  limiter:    { threshold: -5, ratio: 7.5, attack: 0.003, release: 0.15 },
  stereoWidth: 1.2,
  reverb: 0.08
},
"Funky": {
  eq: [3.8, 3, 2.2, 1.2, 0, -0.8, 0.3, 1.5, 2.5, 3, 3.2, 2.5],
  enhancer:   { presence: 0.7, brilliance: 0.6, warmth: 0.7 },
  compressor: { threshold: -9.5, ratio: 3.5, attack: 4, release: 68 },
  limiter:    { threshold: -3.5, ratio: 9, attack: 0.003, release: 0.12 },
  stereoWidth: 1.2,
  reverb: 0.16
},
"Scoopy Smile": {
  eq: [5.5, 4.2, 2, -2.8, -4.5, -6, -4, -1.5, 1.5, 3.5, 4.8, 5.5],
  enhancer: { presence: 0.4, brilliance: 0.7, warmth: 0.3 },
  compressor: { threshold: -16, ratio: 3.2, attack: 5, release: 75 },
  stereoWidth: 1.4
},
"AmbientSpace": {
  eq: [1.2, 0.8, 0.4, 0, -0.2, -0.6, 0.3, 1.5, 2.4, 3.0, 3.5, 3.0],
  enhancer:   { presence: 0.4, brilliance: 0.6, warmth: 0.2 },
  compressor: { threshold: -18, ratio: 2.0, attack: 4, release: 100 },
  limiter:    { threshold: -6, ratio: 7.0, attack: 0.005, release: 0.3 },
  stereoWidth: 1.6,
  reverb: 0.35
},
"Bassy Theater": {
  eq: [3.5, 3.2, 3, 2.5, 1.5, 0.5, -0.5, -1, -1.2, -0.8, -0.5, 0],
  enhancer:   { presence: 0.4, brilliance: 0.2, warmth: 0.7 },
  compressor: { threshold: -12, ratio: 3.2, attack: 6, release: 100 },
  limiter:    { threshold: -4, ratio: 8, attack: 0.0035, release: 0.25 },
  stereoWidth: 1.1,
  reverb: 0.18
},
"Bright Vocal": {
  eq: [3, 2.8, 2.2, 1.5, 0, -0.5, 0.5, 2.5, 3.2, 3.8, 4.2, 4.5],
  enhancer:   { presence: 0.9, brilliance: 0.7, warmth: 0.3 },
  compressor: { threshold: -12, ratio: 3, attack: 5, release: 55 },
  limiter:    { threshold: -5, ratio: 8, attack: 0.003, release: 0.16 },
  stereoWidth: 1.15,
  reverb: 0.18
},
  "StudioPro": {  
  eq: [1.5, 1.2, 1, 0.5, 0, 0, 0.5, 1.2, 2.5, 3.2, 3.5, 3.8],  
  enhancer:   { presence: 0.6, brilliance: 0.55, warmth: 0.6 },  
  compressor: { threshold: -13.5, ratio: 3, attack: 3, release: 75 },  
  limiter:    { threshold: -5.2, ratio: 7.5, attack: 0.004, release: 0.2 },  
  stereoWidth: 1.4,  
  reverb: 0.2  
},  
"Funky Shape": {
  eq: [3.5, 3, 2.5, 0.5, -1, -2.5, -1, 0.8, 2.2, 3.2, 3.5, 2.8],
  enhancer: { presence: 0.6, brilliance: 0.4, warmth: 0.6 },
  compressor: { threshold: -11, ratio: 3.3, attack: 4, release: 60 },
  limiter: { threshold: -4, ratio: 8.5, attack: 0.004, release: 0.16 },
  stereoWidth: 1.1,
  reverb: 0.1
},
"AmbientNature": {
  eq: [0.5, 0.3, 0, -0.2, -0.4, -0.5, 0.1, 0.7, 1.2, 1.8, 2.0, 1.5],
  enhancer:   { presence: 0.5, brilliance: 0.5, warmth: 0.6 },
  compressor: { threshold: -20, ratio: 1.8, attack: 3, release: 120 },
  limiter:    { threshold: -7, ratio: 6.0, attack: 0.006, release: 0.25 },
  stereoWidth: 1.5,
  reverb: 0.28
},
"Clean Dialog": {
  eq: [1.2, 1, 0.8, 0.5, 0.2, 0, 0.1, 0.8, 1.2, 1.5, 1.7, 1.5],
  enhancer:   { presence: 0.8, brilliance: 0.5, warmth: 0.3 },
  compressor: { threshold: -16, ratio: 2.3, attack: 3.8, release: 85 },
  limiter:    { threshold: -4.5, ratio: 7.2, attack: 0.004, release: 0.18 },
  stereoWidth: 1,
  reverb: 0.05
},
  "CinematicWide": {  
  eq: [2.5, 2.2, 1.8, 1.2, 0.5, 0, 0.8, 1.6, 3.2, 3.8, 4, 4.3],  
  enhancer:   { presence: 0.65, brilliance: 0.6, warmth: 0.75 },  
  compressor: { threshold: -12.5, ratio: 3.2, attack: 2.5, release: 90 },  
  limiter:    { threshold: -4.5, ratio: 7.8, attack: 0.004, release: 0.22 },  
  stereoWidth: 1.55,  
  reverb: 0.32  
},  
"Gaming FPS Focus": {
  eq: [2.5, 2.2, 1.8, 1, 0.5, 0, -0.2, 0.5, 1.5, 2.8, 3, 2.6],
  enhancer:   { presence: 0.9, brilliance: 0.6, warmth: 0.3 },
  compressor: { threshold: -11.5, ratio: 3, attack: 2.5, release: 65 },
  limiter:    { threshold: -4, ratio: 9, attack: 0.0035, release: 0.17 },
  stereoWidth: 1.35,
  reverb: 0.1
},
"Vortex Mode": {
  eq: [0, -2, 2.5, -1.5, 3, -3.5, 2.5, -2, 3, -2, 2.5, -1],
  enhancer: { presence: 0.6, brilliance: 0.6, warmth: 0.6 },
  compressor: { threshold: -13, ratio: 3, attack: 7, release: 65 },
  stereoWidth: 1.5,
  reverb: 0.2
},
"Punchy": {
  eq: [4, 3.5, 2.8, 1.5, 0.5, -0.5, 0.2, 1.5, 2.8, 3.2, 3.5, 3],
  enhancer:   { presence: 0.85, brilliance: 0.5, warmth: 0.5 },
  compressor: { threshold: -10, ratio: 4, attack: 3, release: 60 },
  limiter:    { threshold: -2.5, ratio: 10.5, attack: 0.003, release: 0.11 },
  stereoWidth: 1.2,
  reverb: 0.09
},
"Boom Room": {  
  eq: [3.5, 3, 2.5, 1.5, 0.5, -0.2, 0.4, 1, 1.8, 2.5, 3, 3.2],  
  enhancer:   { presence: 0.5, brilliance: 0.3, warmth: 0.75 },  
  compressor: { threshold: -13, ratio: 3.2, attack: 3, release: 75 },  
  limiter:    { threshold: -3.8, ratio: 8, attack: 0.0035, release: 0.17 },  
  stereoWidth: 1.1,  
  reverb: 0.18  
},  
"MidCut": {
  eq: [2, 2, 2.5, -1.5, -3.5, -4.5, -3.5, -1.5, 2, 3.2, 3.5, 3],
  enhancer:   { presence: 0.5, brilliance: 0.5, warmth: 0.4 },
  compressor: { threshold: -10, ratio: 2.8, attack: 5, release: 65 },
  limiter:    { threshold: -3.5, ratio: 8, attack: 0.003, release: 0.12 },
  stereoWidth: 1.3,
  reverb: 0.08
},
"Hardcore Punch": {  
  eq: [3.2, 2.8, 2.5, 1.8, 1, 0, -0.5, 0.2, 1.2, 2.5, 2.8, 2.2],  
  enhancer:   { presence: 0.8, brilliance: 0.5, warmth: 0.6 },  
  compressor: { threshold: -10, ratio: 3.8, attack: 3, release: 65 },  
  limiter:    { threshold: -3.5, ratio: 9, attack: 0.003, release: 0.15 },  
  stereoWidth: 1.2,  
  reverb: 0.07  
},  
   "Movie": {
  eq: [2.2, 2, 1.8, 1.2, 0.5, 0, 0.5, 1.5, 2.8, 3.2, 3.4, 3.5],
  enhancer:   { presence: 0.5, brilliance: 0.4, warmth: 0.7 },
  compressor: { threshold: -14, ratio: 2.8, attack: 3.5, release: 85 },
  limiter:    { threshold: -5, ratio: 7, attack: 0.004, release: 0.19 },
  stereoWidth: 1.4,
  reverb: 0.2
},
  "ClubNight": {  
  eq: [4, 3.5, 3, 2, 1, 0, -1, 0.5, 2, 3.5, 4, 4.2],  
  enhancer:   { presence: 0.85, brilliance: 0.7, warmth: 0.65 },  
  compressor: { threshold: -10, ratio: 4.2, attack: 2.8, release: 70 },  
  limiter:    { threshold: -3, ratio: 9, attack: 0.002, release: 0.16 },  
  stereoWidth: 1.5,  
  reverb: 0.3  
},  
  "Dolby Atmos Style": {  
  eq: [2.8, 2.5, 2.2, 1.5, 1, 0, 0.5, 1.2, 2.5, 3, 3.5, 3.8],  
  enhancer:   { presence: 0.7, brilliance: 0.6, warmth: 0.75 },  
  compressor: { threshold: -12, ratio: 3.5, attack: 2.5, release: 80 },  
  limiter:    { threshold: -4, ratio: 8, attack: 0.003, release: 0.18 },  
  stereoWidth: 1.5,  
  reverb: 0.25  
},  
"LoFi Mode": {
  eq: [1.5, 0.8, 0.2, -0.5, -1.5, -2.5, -2, -1.2, -0.5, 0.5, 1, 1.5],
  enhancer: {
    presence: 0.3,
    brilliance: 0.2,
    warmth: 0.7
  },
  compressor: {
    threshold: -16,
    ratio: 2.5,
    attack: 10,
    release: 120
  },
  limiter: {
    threshold: -6,
    ratio: 6,
    attack: 0.005,
    release: 0.2
  },
  stereoWidth: 0.9,
  reverb: 0.25
},
};


// === 🎧 PRESET EQ DEFINITION  
const volumeBoostPresets = {
  "Volume++": {
    eq: [2, 1.5, 1.2, 0.8, 0, 1, 1.8, 2.2, 2.8, 3.5, 3, 2],
    enhancer: 1.4,
    compressor: -13.5,
    limiter: {
      enabled: true,
      threshold: -2.8
    },
    stereoWidth: 1.08,
    reverb: {
      enabled: false
    },
    filters: (ctx) => {
      const lowShelf = ctx.createBiquadFilter();
      lowShelf.type = "lowshelf";
      lowShelf.frequency.value = 55;
      lowShelf.gain.value = 0.3; // Halusin bass lebih soft

      const subDip = ctx.createBiquadFilter();
      subDip.type = "peaking";
      subDip.frequency.value = 90;
      subDip.Q.value = 1.2;
      subDip.gain.value = -1.5; // Tambah dip-nya

      const lowMidCut = ctx.createBiquadFilter();
      lowMidCut.type = "peaking";
      lowMidCut.frequency.value = 280; // Dari 320 → 280
      lowMidCut.Q.value = 1.2;          // Sedikit lebih sempit
      lowMidCut.gain.value = -1.6;      // Cut lebih dalam

      const midBody = ctx.createBiquadFilter();
      midBody.type = "peaking";
      midBody.frequency.value = 1150;
      midBody.Q.value = 1.3;
      midBody.gain.value = 1.2;

const clarity = ctx.createBiquadFilter();
clarity.type = "peaking";
clarity.frequency.value = 3800;
clarity.Q.value = 1.1;
clarity.gain.value = 0.7;

const highShelf = ctx.createBiquadFilter();
highShelf.type = "highshelf";
highShelf.frequency.value = 9000;
highShelf.gain.value = 0.4;

const air = ctx.createBiquadFilter();
air.type = "highshelf";
air.frequency.value = 17000;
air.gain.value = 0.25;

const harshTamer = ctx.createBiquadFilter();
harshTamer.type = "peaking";
harshTamer.frequency.value = 5300;
harshTamer.Q.value = 4.2;
harshTamer.gain.value = -1.4;

const shimmer = ctx.createBiquadFilter();
shimmer.type = "highshelf";
shimmer.frequency.value = 16000;
shimmer.gain.value = 0.1;

return [lowShelf, subDip, lowMidCut, midBody, clarity, harshTamer, highShelf, air, shimmer];
    }
  },
};


// Gabung semua preset
const allPresets = {
  ...eqPresets,
  ...volumeBoostPresets
};


// === APPLY PRESET TO EQ, COMPRESSOR, VOLUME ===  
function applyFullPreset(name, preset) {  
  try {  
    if (!preset || !eqNodes.length) {  
      console.warn(`❌ Preset "${name}" tidak valid atau EQ belum siap`);  
      return;  
    }  
  
    // === EQ Sliders  
    isUpdatingSlider = true;  
    preset.eq.forEach((db, i) => {  
      const slider = document.querySelectorAll('.slider')[i];  
      const clampedDb = Math.max(-12, Math.min(12, db));  
      if (slider) slider.value = 50 + clampedDb * 5;  
      if (eqNodes[i]) eqNodes[i].gain.value = clampedDb;  
    });  
    isUpdatingSlider = false;  
  
    // === Enhancer (Gain Node)  
    if (preset.enhancer !== undefined && gainNode) {  
      const gain = Math.max(0.1, Math.min(5, preset.enhancer));  
      gainNode.gain.value = gain;  
      console.log(`🎛️ Enhancer gain set to: ${gain}`);  
    }  
  
    // === Compressor  
    if (compressor) {  
      if (typeof preset.compressor === "number") {  
        compressor.threshold.value = preset.compressor;  
      } else if (typeof preset.compressor === "object") {  
        const { threshold, ratio, attack, release } = preset.compressor;  
        if (threshold !== undefined) compressor.threshold.value = threshold;  
        if (ratio !== undefined) compressor.ratio.value = ratio;  
        if (attack !== undefined) compressor.attack.value = attack;  
        if (release !== undefined) compressor.release.value = release;  
      }  
    }  
  
    // === Custom Filters  
    if (typeof preset.filters === "function" && audioCtx && sourceNode) {  
      const customFilters = preset.filters(audioCtx);  
      if (Array.isArray(customFilters)) {  
        // Disconnect old connections  
        try { sourceNode.disconnect(); } catch (_) {}  
        let chain = sourceNode;  
        customFilters.forEach(node => {  
          chain.connect(node);  
          chain = node;  
        });  
        chain.connect(audioCtx.destination);  
        console.log("🎚️ Custom filters applied.");  
      }  
    }  
  
    // === Extra Nodes  
    if (preset.extraNodes) {  
      Object.entries(preset.extraNodes).forEach(([nodeName, values]) => {  
        const node = window[nodeName];  
        if (!node) return;  
        Object.entries(values).forEach(([param, val]) => {  
          if (node[param] !== undefined) node[param].value = val;  
        });  
      });  
    }  
  
  // === Custom logic: Flat Mode  
  if (name === "Flat") {  
    if (clarity) clarity.gain.value = 2.5;  
    if (clarity) clarity.frequency.value = 4200;  
    if (clarityGain) clarityGain.gain.value = 0.75;  
    if (toneBias) toneBias.gain.value = 1.3;  
    if (deEsser) deEsser.gain.value = -4;  
    console.log("🎧 Flat preset applied");  
  }  
  
  // === Custom logic: Volume++ Mode  
  if (name === "Volume++") {  
    if (masterGain) masterGain.gain.value = 1.7;  
  
    if (clarity) clarity.gain.value = 2.8;  
    if (clarity) clarity.frequency.value = 4300;  
    if (clarityGain) clarityGain.gain.value = 0.75;  
    if (toneBias) toneBias.gain.value = 1.4;  
    if (enhancer) enhancer.gain.value = 3.5;  
    if (deEsser) deEsser.gain.value = -5;  
  
    if (stereoPanner) stereoPanner.pan.value = 0;  
  
    if (softLimiter) {  
      softLimiter.threshold.value = -5;  
      softLimiter.knee.value = 10;  
      softLimiter.ratio.value = 12;  
      softLimiter.attack.value = 0.003;  
      softLimiter.release.value = 0.2;  
    }  
  
    if (smartLimiter) {  
      smartLimiter.threshold.value = -3;  
      smartLimiter.ratio.value = 15;  
    }  
      
    console.log("🔥 Volume++ preset aktif: full power!");  
  }  
  
    // === VolumeBoost (Preset custom logic)  
    if (preset.volumeBoost !== undefined && gainNode) {  
      const vol = Math.max(0, Math.min(2, preset.volumeBoost));  
      gainNode.gain.value = vol;  
      console.log(`🔊 VolumeBoost: ${vol}`);  
    }  
  
    lastManualPreset = name;  
    console.log(`✅ Applied: ${name} | Enhancer: ${preset.enhancer} | Compressor: ${JSON.stringify(preset.compressor)}`);  
  } catch (err) {  
    console.error("❌ applyFullPreset error:", err);  
  }  
}  
  
// === APPLY COMBINED EQ + VOLUME PRESETS ===  
function applyPresetCombined(eqName, volName = "Volume++") {  
  if (!eqName) {  
    console.warn("❌ EQ preset kosong, dibatalkan");  
    return;  
  }  
  
  const eqPreset = allPresets[eqName];  
  const volPreset = allPresets[volName];  
  
  if (!eqPreset) {  
    console.warn(`❌ EQ preset '${eqName}' tidak ditemukan`);  
    return;  
  }  
  
  const fullPreset = { ...eqPreset };  
  
  // Gabungkan enhancer dan compressor dari volPreset (kecuali kalo eqName udah "Volume++")  
  if (volPreset && eqName !== "Volume++") {  
    if (volPreset.enhancer !== undefined) fullPreset.enhancer = volPreset.enhancer;  
    if (volPreset.compressor !== undefined) fullPreset.compressor = volPreset.compressor;  
  }  
  
  console.log(`🎛️ Combined preset: EQ='${eqName}' + Volume='${volName}'`);  
  applyFullPreset(eqName, fullPreset);  
  

  if (volPreset) {
    if (volPreset.enhancer !== undefined && enhancer)
      enhancer.gain.value = volPreset.enhancer;
    if (volPreset.compressor !== undefined && compressor)
      compressor.threshold.value = volPreset.compressor;
    console.log(`🔊 Volume preset injected: '${volName}'`);
  }

  lastVolPreset = volName;  
  saveLastPreset(eqName, volName);  
}  
  
// === SMART APPLY (based on playing status)  
function applyPresetSmart(name) {  
  if (!audioCtx || !sourceNode) initAudioContext();  
  
  const audio = document.getElementById("audioPlayer") || document.getElementById("media");  
  
  if (audio.paused) {  
    pendingEQPreset = name;  
  } else {  
    applyPresetCombined(name, "Volume++");  
  }  
  
  lastManualPreset = name;  
}  
  
// === SAVE/LOAD TO LOCALSTORAGE  
function saveLastPreset(eq, vol) {  
  localStorage.setItem("lastEQ", eq);  
  localStorage.setItem("lastVol", vol);  
}  
  
function loadLastPreset() {  
  return {  
    eq: localStorage.getItem("lastEQ") || "Flat",  
    vol: localStorage.getItem("lastVol") || "Volume++"  
  };  
}  
  

  
const audioPipelines = {}; // Untuk simpan chain per player (by ID/nama)

function setupAudioPipeline(element, playerId = "default") {
  initAudioContext();

  // Jika sebelumnya sudah ada, disconnect semua
  if (audioPipelines[playerId]?.source) {
    try { audioPipelines[playerId].source.disconnect(); } catch (e) {}
  }

    const frequencies = [10, 32, 64, 125, 250, 500, 1000, 2000, 4000, 10000, 16000, 20000];  
    eqNodes = frequencies.map(freq => {  
      const f = audioCtx.createBiquadFilter();  
      f.type = "peaking";  
      f.frequency.value = freq;  
      f.Q.value = 1;  
      f.gain.value = 0;  
      return f;  
    });  
  
  // Connect EQ → Compressor → Gain → Output  
  sourceNode.connect(eqNodes[0]);  
  for (let i = 0; i < eqNodes.length - 1; i++) {  
    eqNodes[i].connect(eqNodes[i + 1]);  
  }  
  eqNodes.at(-1).connect(compressor);  
  compressor.connect(gainNode);  
  gainNode.connect(audioCtx.destination);  
  
  // Simpan ke audioPipelines
  audioPipelines[playerId] = {
    source,
    eq,
    compressor,
    gain,
    element
  };

  console.log(`✅ Audio pipeline siap untuk "${playerId}"`);

  // Apply preset default
  const presetName = presetSelect?.value || "Flat";
  if (eqPresets[presetName]) {
    applyFullPresetTo(eqPresets[presetName], audioPipelines[playerId]);
  }
}
  
  
// === Auto apply preset saat audio diputar  
const videoElement = document.getElementById("media");  
const audioElement = document.getElementById("audio");  
  
// Sinkronisasi video → audio  
videoElement.addEventListener("play", () => {  
  audioElement.play();  
});  
videoElement.addEventListener("pause", () => {  
  audioElement.pause();  
});  
videoElement.addEventListener("seeking", () => {  
  audioElement.currentTime = videoElement.currentTime;  
});  
  
// Sinkronisasi audio → preset & gainNode (EQ)  
audioElement.addEventListener("play", async () => {  
  if (!audioElement.src) return;  
  
  if (autoApplyPresetOnPlay) {  
    const preset = allPresets[lastManualPreset];  
    if (!preset) return;  
  
    try {  
      await audioContext.resume();  
  
      // Pastikan koneksi masih aman  
      try { gainNode.disconnect(); } catch (_) {}  
      gainNode.connect(audioContext.destination);  
  
      // HANYA applyFullPreset, karena gain sudah diset di luar  
      applyFullPreset(lastManualPreset, preset);  
    } catch (err) {  
      console.warn("⚠️ AudioContext resume gagal:", err);  
    }  
  }  
});  
  
// === FILE PICKER LOGIC ===  
fileInput.addEventListener('change', e => {  
  const file = e.target.files[0];  
  if (!file) return;  
  
  const url = URL.createObjectURL(file);  
  const isVideo = file.type.startsWith("video");  
  
  if (isVideo) {  
    mediaEl.src = url;  
    mediaEl.hidden = false;  
    audioEl.hidden = true;  
    setupAudioPipeline(mediaEl);  
  } else {  
    audioEl.src = url;  
    audioEl.hidden = false;  
    mediaEl.hidden = true;  
    setupAudioPipeline(audioEl);  
  }  
});  
  
// === DROPDOWN CHANGE LISTENER ===  
presetSelect.addEventListener("change", () => {  
  applyPresetSmart(presetSelect.value);  
});  
  
// === AUTO LOAD LAST PRESET ===  
document.addEventListener("DOMContentLoaded", () => {  
  createEQSliders();  
  
  const { eq, vol } = loadLastPreset();  
  applyPresetCombined(eq, vol);  
  
  // Set dropdown UI  
  presetSelect.value = eqPresets[eq] ? eq : "Flat";  
});  


    // ============ ▶️ PLAYER CONTROL ============  
function formatTime(seconds) {  
  const m = Math.floor(seconds / 60);  
  const s = Math.floor(seconds % 60);  
  return `${m}:${s.toString().padStart(2, '0')}`;  
}  
function updateTimer() {  
  timerText.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration || 0)}`;  
}  
function loadTrack(index) {  
  const track = playlist[index];  
  if (!track) return;  
}  

function initAudioContext() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaElementSource(audio);
    gainNode = audioCtx.createGain();
    gainNode.gain.value = 2.0; // 🔊 Lock volume 200%

    source.connect(gainNode).connect(audioCtx.destination);
  }
}

// ============ 📌 EVENT ============  
document.addEventListener("DOMContentLoaded", () => {  
  createEQSliders();  
  loadTrack(currentTrack);  
  updateVolume(100);  
  
  const EQpresetSelect = document.getElementById("presetSelect");  
  if (basicSelect) {  
    presetSelect.addEventListener("change", e => {  
      const val = e.target.value;  
      if (EQPresets[val]) applyFullPreset(val, EQPresets[val]);  
    });  
  }  
});  

// ========== 🎧 STEREO PAN FINAL ==========
let stereoEnabled = false;
let panTimer = null;
let panPos = 0;
let panDir = 1;

let swingTimer = null;
let isStereoOn = false;
let autoPan = false;

let stereoAnalyser;

function applyStereoRouting() {
  if (!audioCtx || !eqNodes.length) return;

  // Disconnect semua dulu
  eqNodes[eqNodes.length - 1].disconnect();
  stereoPanner?.disconnect();
  stereoGain?.disconnect();
  crossfeed?.disconnect();
  stereoAnalyser?.disconnect();

  isStereoOn = !isStereoOn;

  const finalNode = eqNodes[eqNodes.length - 1];

  // Crossfeed SELALU AKTIF
  crossfeed = audioCtx.createGain();
  crossfeed.gain.value = 0.05;
  finalNode.connect(crossfeed);
  crossfeed.connect(audioCtx.destination);

  if (stereoEnabled) {
    stereoPanner = audioCtx.createStereoPanner();
    stereoGain = audioCtx.createGain();
    stereoGain.gain.value = 0.9;

    // 🔊 Buat analyser stereo
    stereoAnalyser = audioCtx.createAnalyser();
    stereoAnalyser.fftSize = 256;

    // Rantai: FinalNode → StereoPanner → Gain → Destination + Analyser
    finalNode.connect(stereoPanner);
    stereoPanner.connect(stereoGain);
    stereoGain.connect(audioCtx.destination);
    stereoGain.connect(stereoAnalyser); // <= Kirim ke analyser

    startSlowPan();
  } else {
    finalNode.connect(audioCtx.destination);
    stopSlowPan();
  }

  updateStereoBtnUI();
}

function startSlowPan() {
  stopSlowPan();
  panPos = 0;
  panDir = 1;

  panTimer = setInterval(() => {
    if (!stereoPanner) return;
    panPos += panDir * 0.002;
    if (panPos >= 0.8 || panPos <= -0.8) panDir *= -1;
    stereoPanner.pan.setValueAtTime(panPos, audioCtx.currentTime);
    drawStereoPanVisual(); // 🎨 Update visual
  }, 30);
}

function stopSlowPan() {
  clearInterval(panTimer);
  panTimer = null;
}
    
let running = false;
let rafId;

function loop60fps() {
  if (!running) return;
  rafId = requestAnimationFrame(loop60fps);
}

function startLoop() {
  if (!running) {
    running = true;
    console.log("60FPS Loop:  ON");
    loop60fps();
  }
}

function stopLoop() {
  if (running) {
    running = false;
    cancelAnimationFrame(rafId);
    console.log("60FPS Loop:  OFF");
  }
}

// Expose buat bisa dipanggil di console
window.startLoop = startLoop;
window.stopLoop = stopLoop;

// Auto start kalau mau
startLoop();

function openFullscreen() {
  const video = document.getElementById('videoPlayer');
  if (video.requestFullscreen) {
    video.requestFullscreen();
  } else if (video.webkitRequestFullscreen) { // Safari
    video.webkitRequestFullscreen();
  } else if (video.msRequestFullscreen) { // IE11
    video.msRequestFullscreen();
  }
}
    
  window.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById("visualMode");

  if (!el) {
    console.warn("Elemen #visualMode tidak ditemukan!");
    return;
  }

  console.log("🔵 Mode visual aktif!");

  // Tes tambahkan class manual satu-satu
  el.classList.add("dolby-vision");
  el.classList.remove("bravia-cinematic");
  el.classList.toggle("huawei-vivid");

  // Gabungan semuanya?
  el.classList.add("visual-mode-all");
});


const visualEngineSettings = {
  postProcess: {
    exposure: {
      minBrightness: 0.8,
      maxBrightness: 1.2,
      autoAdjust: true,
      speed: 0.15
    },
    contrast: 1.15,
    saturation: 1.1,
    bloom: {
      enabled: true,
      intensity: 0.3,
      threshold: 1.1
    },
    vignette: {
      enabled: true,
      intensity: 0.15,
      smoothness: 0.6
    },
    chromaticAberration: {
      enabled: true,
      intensity: 0.02
    },
    motionBlur: {
      enabled: true,
      shutterAngle: 90
    },
    colorGrading: {
      lift: [1.0, 1.0, 1.0],
      gamma: [1.05, 1.05, 1.05],
      gain: [1.1, 1.1, 1.1]
    },
    lensFlare: {
      enabled: true,
      intensity: 0.2
    },
    ambientOcclusion: {
      enabled: true,
      radius: 0.5,
      intensity: 0.6
    },
    depthOfField: {
      enabled: true,
      focalDistance: 3.0,
      aperture: 2.8,
      blurAmount: 0.5
    }
  },
  skybox: {
    type: "gradient",
    topColor: "#1c1c2a",
    bottomColor: "#5c6c80"
  },
  lighting: {
    direction: [0.5, -1, 0.3],
    intensity: 1.0,
    color: "#ffffff",
    shadows: true
  },
  autoControl: {
    autoplay: true,
    loop: true,
    muted: false,
    volume: 1.0,
    controlsVisible: false
  }
};

  const canvas = document.getElementById("hiddenCanvas");

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
  camera.position.z = 5;

  const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
  renderer.setSize(256, 256); // kecilin ukuran, cukup buat proses belakang layar

  // Buat object 3D
  const geometry = new THREE.BoxGeometry(2, 2, 2);
  const material = new THREE.MeshStandardMaterial({ color: 0x00ffcc });
  const cube = new THREE.Mesh(geometry, material);
  scene.add(cube);

  // Lighting
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5, 5, 5);
  scene.add(light);

  // Render loop (background)
  let frame = 0;
  function animate() {
    requestAnimationFrame(animate);
    cube.rotation.x += 0.01;
    cube.rotation.y += 0.01;

    renderer.render(scene, camera);

    if (++frame % 60 === 0) {
      console.log("🎥 Background 3D rendering still active", frame);
    }
  }

  animate();

let lastTap = 0;
const videoPlayer = document.getElementById('realisticPlayer');

videoPlayer.addEventListener('touchend', () => {
  const now = new Date().getTime();
  if (now - lastTap < 300) {
    toggleUIPreset(); // panggil fungsi lama
  }
  lastTap = now;
});

videoPlayer.addEventListener('click', () => {
  const now = new Date().getTime();
  if (now - lastTap < 300) {
    toggleUIPreset(); // panggil fungsi lama juga untuk desktop
  }
  lastTap = now;
});

const dropdown = document.getElementById('dropdownPanel');
videoPlayer.addEventListener('play', () => {
  if (dropdown) {
    dropdown.style.display = 'none';
  }
});

function toggleUIPreset() {
  const dropdown = document.getElementById('dropdownPanel');
  if (dropdown) {
    dropdown.style.display = (dropdown.style.display === 'none' || dropdown.style.display === '') ? 'block' : 'none';
  }
}

  function toggleUIPreset() {  
    const panel = document.getElementById('uiControls');  
    const btn = document.getElementById('toggleUIPanel');  
    const isHidden = panel.classList.toggle('hidden');  
  
    btn.textContent = isHidden ? ' Show UI' : ' UI Panel';  
  }  
  
  // Optional: start with UI hidden  
  // document.getElementById('uiControls').classList.add('hidden');  


let lastTime = performance.now();
let frames = 0;

function checkFPS() {
  const now = performance.now();
  frames++;
  if (now - lastTime >= 1000) {
    console.log("FPS:", frames);
    frames = 0;
    lastTime = now;
  }
  requestAnimationFrame(checkFPS);
}

checkFPS();


  if ('serviceWorker' in navigator) {    
    navigator.serviceWorker.register('sw.js')    
      .then(reg => console.log('✅ Service Worker registered:', reg.scope))    
      .catch(err => console.error('❌ Service Worker registration failed:', err));    
  }    

      console.log("✅ Script Loaded");      
  </script>
</body>
</html>
